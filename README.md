#Spikes Client Developer Manual

## 1. PROJECT INFORMATION

### Purpose and Objectives
Spikes is a comprehensive CRM/ERP system designed for contract management, lead tracking, and financial operations. The system provides multi-tenant architecture supporting different user roles and permissions, enabling businesses to manage their complete sales and contract lifecycle.

### Use Cases / Business Logic
The main business flows include:
- **Contract Management**: Create, track, and manage contracts with document generation capabilities
- **Lead Management**: Track and prioritize potential customers through the sales funnel
- **Campaign Management**: Organize and monitor marketing campaigns
- **Financial Operations**: Generate invoices, manage liquidations and financial settlements
- **Document Generation**: Create legal documents ("Justo Título") and invoices in PDF format
- **Task Management**: Schedule and track tasks through the agenda system
- **File Management**: Store and organize documents through the Drive feature

### Business Domain Glossary
- **Contratos**: Contracts - Main business entity representing agreements with clients
- **Liquidaciones**: Settlements/Liquidations - Financial settlements and payment processing
- **Leads**: Potential customers in the sales pipeline
- **Campañas**: Marketing campaigns for customer acquisition
- **Usuarios**: System users with different access levels
- **Companies**: Business entities that can have contracts
- **Canales**: Channels - Distribution or communication channels
- **Estados**: States - Status of contracts or leads in the workflow
- **Origins**: Sources where leads originate from
- **Justo Título**: Legal ownership document generated by the system

## 2. ENVIRONMENT CONFIGURATION

### Environment Variables
```bash
# API Configuration
NEXT_PUBLIC_API_URL=http://localhost:3000  # Public API endpoint for client-side calls
API_URL=http://localhost:3000              # Server-side API endpoint
NEXT_PUBLIC_URL_CONTRACT=http://localhost:4000  # Contract service endpoint

# Security
JWT_SECRET=!7Kk1fQdfWWf5  # Secret key for JWT token verification

# Environment
NODE_ENV=development  # Environment mode (development/production)
```

### Installation and Setup Instructions
1. Clone the repository
2. Install dependencies:
   ```bash
   npm install
   ```
3. Create `.env.local` file with the environment variables listed above
4. Run the development server:
   ```bash
   npm run dev
   ```
5. Access the application at `http://localhost:4000`

### Relevant Commands
```bash
# Development
npm run dev      # Start development server on port 4000

# Building
npm run build    # Create production build
npm run start    # Start production server

# Code Quality
npm run lint     # Run ESLint for code linting
```

## 3. PROJECT STRUCTURE

### Architecture and Design Patterns
The project follows a **Component-based Architecture** with Next.js 14 App Router. Key architectural decisions include:
- File-based routing using Next.js App Router
- Client-side state management with React hooks and Context API
- JWT-based authentication with middleware protection
- Separation of concerns between pages, components, and helpers
- API abstraction layer through helper functions

### Technology Stack
- **Framework**: Next.js 14.2.13 (App Router)
- **UI Library**: React 18
- **Styling**: Tailwind CSS 3.4.1
- **Authentication**: JWT with jose 5.9.2
- **UI Components**: 
  - react-icons 5.3.0
  - react-select 5.10.2
  - react-toastify 11.0.5
  - react-dnd 16.0.1
- **Document Generation**:
  - @react-pdf/renderer 4.3.0
  - jspdf 3.0.1
  - xlsx 0.18.5
- **Utilities**:
  - date-fns 4.1.0
  - uuid 11.1.0
  - cookies-next 4.2.1

### Version and Main Dependencies
- **Project Version**: Not specified in package.json
- **Node Version**: Not specified (recommend Node 18+)
- **Package Manager**: npm

### Directory Organization
```
/
├── app/                    # Next.js App Router pages and routes
│   ├── api/               # API routes
│   │   └── auth/         # Authentication endpoints
│   ├── campaigns/         # Campaign management pages
│   ├── contracts/         # Contract management pages
│   ├── drive/            # File management pages
│   ├── leads/            # Lead management pages
│   ├── liquidaciones/    # Financial settlements pages
│   ├── perfil/           # User profile pages
│   ├── settings/         # System settings (admin only)
│   ├── usuarios/         # User management (managers only)
│   └── page.js           # Login page (root)
├── components/            # Reusable React components
│   ├── drive/            # File management components
│   ├── perfil/           # Profile-related components
│   └── *.modal/form/section.js  # Various UI components
├── helpers/              # Utility functions
│   ├── dates.helper.js   # Date formatting utilities
│   ├── notification.helper.js  # Notification handling
│   ├── server-fetch.helper.js  # API fetch wrappers
│   ├── strings.helper.js       # String manipulation
│   └── validation.helper.js    # Form validation
├── hooks/                # Custom React hooks
│   └── useIsMobile.js    # Responsive design detection
└── public/               # Static assets
    ├── fonts/           # Geist font family
    └── images/          # Logos and icons
```

### Naming Conventions
- **Components**: PascalCase with type suffix (e.g., `CreateCustomerForm`, `NewUserModal`)
- **Files**: kebab-case with type indicator (e.g., `create-customer.form.js`, `new-user.modal.js`)
- **Routes**: kebab-case following REST conventions
- **Variables**: camelCase for JavaScript variables and functions
- **CSS Classes**: Tailwind utility classes, custom classes use kebab-case

### Configuration Files Location
- `/next.config.mjs` - Next.js configuration (React strict mode disabled)
- `/jsconfig.json` - Path aliases configuration (`@/` maps to root)
- `/tailwind.config.js` - Tailwind CSS custom theme configuration
- `/postcss.config.mjs` - PostCSS configuration
- `/middleware.js` - Authentication and route protection middleware
- `/.env.local` - Environment variables (not in version control)

### Component Lifecycle and Data Flow
1. **User Interaction**: User clicks button or submits form
2. **Event Handler**: React component handles the event
3. **State Update**: Local state updated via `useState` or context
4. **API Call**: Helper function makes authenticated request to backend
5. **Response Processing**: Data processed and errors handled
6. **UI Update**: Component re-renders with new data
7. **Notification**: Success/error shown via react-toastify

### Separation of Responsibilities
- **`/app`**: Page components handling routing and layout
- **`/components`**: Reusable UI components with specific responsibilities
- **`/helpers`**: Pure utility functions for common operations
- **`/hooks`**: Custom React hooks for shared logic
- **`/middleware.js`**: Authentication and authorization logic
- **`/public`**: Static assets served directly

## 4. STATE MANAGEMENT

### State Management Strategy
The project uses React's built-in state management solutions without external libraries. State is managed at three levels:
1. **Component State**: Using `useState` for local component data
2. **Context State**: Using React Context API for layout and authentication state
3. **Cookie State**: JWT tokens stored in cookies for persistence

### Global Store Structure
No global store implementation exists. The project uses `LayoutContext` for minimal global state:
```javascript
{
  sideBarHidden: boolean,      // Sidebar visibility state
  setSideBarHidden: function   // Setter for sidebar state
}
```

### Data Flow and Actions
1. **Authentication Flow**:
   - Login credentials → API call → JWT token → Cookie storage
   - Middleware reads cookie → Verifies JWT → Allows/denies access
   
2. **Component Data Flow**:
   - User action → Event handler → API call via helpers
   - Response → State update → Component re-render

3. **Form Data Flow**:
   - Input change → handleChange → setState → Controlled component update

### Local vs Global State Guidelines
- **Use Local State for**:
  - Form data and validation
  - UI toggle states (modals, dropdowns)
  - Component-specific loading states
  - Temporary data that doesn't persist

- **Use Context/Cookies for**:
  - Authentication tokens (cookies)
  - User session data (cookies)
  - Layout preferences (context)
  - Cross-component UI state (context)

## 5. ROUTING AND NAVIGATION

### Application Route Map
```
/ - Login page (public)
/campaigns - Campaign management
/campaigns/[uuid] - Campaign details
/contracts - Contract listing
/contracts/[uuid] - Contract details
/contracts/create - New contract form
/drive - File management system
/drive/[folder] - Folder contents
/leads - Lead management
/leads/[uuid] - Lead details
/liquidaciones - Financial settlements
/liquidaciones/[uuid] - Settlement details
/perfil - User profile
/perfil/tareas - User tasks
/tareas - Task agenda
/usuarios - User management (managers only)
/settings/* - System settings (admin only):
  - /companies - Company management
  - /channels - Channel configuration
  - /states - State management
  - /origins - Lead origin configuration
  - /hide-user - User visibility settings
  - /columns - Column customization
  - /lead-score - Lead prioritization
  - /notifications - Notification settings
  - /factura - Invoice configuration
```

### Protected Routes and Redirections
All routes except `/` (login) are protected by middleware. Access control:
1. **Authentication Check**: Redirects to `/` if no valid JWT token
2. **Manager Routes**: `/usuarios` requires `isManager: true`
3. **Admin Routes**: `/settings/*` requires `groupId === 1` (super admin)
4. **Default Redirect**: Non-managers accessing `/usuarios` → `/contracts`

## 6. API COMMUNICATION

### Fetching Clients and Services
API communication is encapsulated in `/helpers/server-fetch.helper.js`:

```javascript
// Unauthenticated requests
postFetch(endpoint, body)      // POST without auth
getFetch(endpoint)             // GET without auth

// Authenticated requests
authFetch(endpoint, method, body, token)  // Any HTTP method
authGetFetch(endpoint, token)             // GET with auth
authFetchFormData(endpoint, formData, token)  // File uploads
```

### Error Handling for API
- Network errors caught and logged to console
- Response errors checked via `response.ok`
- Error messages displayed using `showErrorMessage()` from notification helper
- Failed authentication redirects to login page via middleware

## 7. AUTHENTICATION AND AUTHORIZATION

### Client Session Management
- **Token Storage**: JWT stored in `factura-token` cookie
- **Token Lifetime**: 24 hours (maxAge: 24 * 60 * 60)
- **Cookie Settings**: 
  - httpOnly: false (accessible via JavaScript)
  - secure: true (in production)
  - sameSite: strict
- **Token Payload**: Contains userId, userEmail, userUuid, groupId, isManager

### Security Patterns
1. **JWT Verification**: All protected routes verify token using jose library
2. **Role-Based Access Control**: Three-tier permission system
3. **Secure Cookie Transmission**: HTTPS required in production
4. **CORS Protection**: SameSite cookie attribute prevents CSRF
5. **Authorization Headers**: Bearer token sent with API requests

### Tokens and Sessions
- **Algorithm**: Not specified in code (likely HS256)
- **Secret**: Stored in JWT_SECRET environment variable
- **Payload Structure**:
  ```javascript
  {
    userId: number,
    userEmail: string,
    userUuid: string,
    groupId: number,
    isManager: boolean
  }
  ```
- **Refresh Strategy**: No refresh token implementation found
- **Logout**: Client-side cookie deletion

### Client-Side Route Protection
Implemented via Next.js middleware (`/middleware.js`):
```javascript
// Protected route patterns
matcher: [
  '/contracts/:path*',
  '/campaigns/:path*',
  '/leads/:path*',
  // ... other protected routes
]
```

## 8. CODE STANDARDS

### Naming Conventions
- **Components**: PascalCase (e.g., `ContractDetailsModal`)
- **Files**: kebab-case with type suffix (e.g., `contract-details.modal.js`)
- **Functions**: camelCase (e.g., `handleSubmit`, `fetchUserData`)
- **Constants**: UPPER_SNAKE_CASE for environment variables
- **CSS Classes**: Tailwind utilities, custom classes in kebab-case
- **API Endpoints**: kebab-case REST conventions

### Code Style
- **Indentation**: 2 spaces
- **Quotes**: Double quotes for JSX attributes, single quotes for JavaScript
- **Semicolons**: Used inconsistently (recommend ESLint configuration)
- **Component Structure**: Functional components with hooks
- **Async/Await**: Preferred over promises
- **Destructuring**: Used for props and state

### Design Patterns Used
- **Container/Presentational**: Not implemented
- **Custom Hooks**: Limited use (only `useIsMobile`)
- **Helper Functions**: Centralized utilities in helpers directory
- **API Abstraction**: Fetch wrappers hide implementation details
- **Middleware Pattern**: Authentication via Next.js middleware

## 9. TESTING

### Testing Strategy
**Not implemented** - No testing framework or test files found in the project

### Testing Tools
**Not implemented** - No testing dependencies in package.json

### Mocks and Fixtures
**Not implemented** - No mock data or fixture files present

## 10. TECHNICAL DOCUMENTATION

### Data Flow
1. **Login Flow**:
   - User enters credentials → POST to `/api/auth/login`
   - Backend validates → Returns JWT token
   - Token stored in cookie → Redirect to `/contracts`
   - Subsequent requests include Bearer token

2. **Contract Creation Flow**:
   - User fills form → Local state management
   - Form submission → Validation
   - API POST request → Backend processing
   - Success response → Redirect to contract list
   - Error response → Display error message

3. **File Upload Flow**:
   - User selects file → FormData creation
   - Upload via `authFetchFormData` → Progress tracking
   - Backend storage → Return file metadata
   - Update UI → Show uploaded file

4. **Lead Management Flow**:
   - Fetch leads list → Display in table
   - Filter/sort leads → Local state update
   - Select lead → Navigate to details
   - Update lead status → API call
   - Refresh list → Show updated status

### Main Use Cases
1. **User Authentication**:
   - Login with username/password
   - Maintain session for 24 hours
   - Role-based access to features

2. **Contract Management**:
   - Create new contracts with customer data
   - Upload supporting documents
   - Generate legal documents
   - Track contract status

3. **Financial Operations**:
   - Create liquidations for contracts
   - Generate invoices
   - Export financial reports

4. **Lead Tracking**:
   - Import leads from various sources
   - Assign priority scores
   - Track conversion pipeline
   - Generate campaign reports